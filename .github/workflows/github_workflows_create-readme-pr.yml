name: Create OctoAcme README PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-readme-pr:
    if: github.event.issue.number == 2 && contains(github.event.comment.body, '/create-readme-pr')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for context, not strictly needed)
        uses: actions/checkout@v4

      - name: Ensure git configured
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create/update docs/README.md via GitHub API
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const path = 'docs/README.md';
            const branchName = `docs/add-octoacme-readme-${process.env.GITHUB_RUN_ID}`;
            const messageCreate = 'docs: add OctoAcme project management README in docs/';
            const messageUpdate = 'docs: update OctoAcme project management README in docs/';

            const contentText = `# OctoAcme Project Management Docs

## Overview

This documentation set captures the project management processes, roles, and artifacts used by OctoAcme to ensure effective delivery, clear ownership, and continuous improvement.

OctoAcme follows an iterative lifecycle covering Initiation, Planning, Execution, Release, and Continuous Improvement. The approach emphasizes delivering small, testable increments that maximize customer value, measuring outcomes to inform decisions, and preserving psychological safety for learning. Core roles include Product Managers (define outcomes and success metrics), Project Managers (coordinate delivery, risks, and communication), Developers (implement and test), QA (validate acceptance), and Stakeholders (approve and guide priority). Workflows rely on a project board pattern for status (Backlog → Ready → In Progress → In Review → QA → Done), small PRs linked to issues and acceptance criteria, and explicit risk/dependency tracking.

Communication and cadence are standardized so teams stay aligned: daily standups for tactical coordination, weekly PM/PdM syncs for planning and escalation, sprint demos/reviews to demonstrate value, and periodic stakeholder updates. Communication templates (weekly status, incident summaries) and a defined escalation path reduce ambiguity and speed resolution of blockers. Quality assurance is integrated into each step — unit/integration tests, CI-based security scans, manual QA for acceptance, pre-release smoke tests, release checklists, and rollback plans — ensuring safe deployments and reliable observability.

These documents are intended to be the single-entrypoint for onboarding and day-to-day use. Each linked doc contains templates, checklists, and step-by-step guidance to apply the process across projects. Retrospectives produce prioritized action items that are tracked back into the backlog so the processes themselves continuously improve.

## Process Documents

- octoacme-project-management-overview.md
- octoacme-project-initiation.md
- octoacme-project-planning.md
- octoacme-execution-and-tracking.md
- octoacme-risks-and-communication.md
- octoacme-release-and-deployment.md
- octoacme-retrospective-and-continuous-improvement.md
- octoacme-roles-and-personas.md

Refer to each file above for templates, checklists, and detailed process instructions.
`;

            const b64 = Buffer.from(contentText, 'utf8').toString('base64');

            // Fetch existing file on main (if any)
            let existing = null;
            try {
              const getResp = await github.rest.repos.getContent({
                owner, repo, path, ref: 'main'
              });
              existing = getResp.data;
            } catch (e) {
              if (e.status === 404) {
                existing = null;
              } else {
                throw e;
              }
            }

            // If file exists and content is identical, comment on the issue and exit
            if (existing) {
              const existingB64 = existing.content;
              // GitHub API returns base64 with newlines; normalize
              const normalizedExisting = existingB64.replace(/\n/g, '');
              if (normalizedExisting === b64) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number: context.issue.number,
                  body: 'docs/README.md already exists on main and content matches the intended README. No PR created.'
                });
                core.setOutput('skipped', 'true');
                return;
              }
            }

            // Create a branch from main
            const mainRef = await github.rest.git.getRef({
              owner, repo, ref: 'heads/main'
            });
            const mainSha = mainRef.data.object.sha;

            await github.rest.git.createRef({
              owner, repo,
              ref: `refs/heads/${branchName}`,
              sha: mainSha
            });

            // Create or update file on the new branch
            if (!existing) {
              await github.rest.repos.createOrUpdateFileContents({
                owner, repo, path, message: messageCreate,
                content: b64, branch: branchName
              });
            } else {
              await github.rest.repos.createOrUpdateFileContents({
                owner, repo, path, message: messageUpdate,
                content: b64, branch: branchName, sha: existing.sha
              });
            }

            core.setOutput('branch', branchName);

      - name: Create Pull Request
        if: steps['Create/update docs/README.md via GitHub API'].outputs.branch != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps['Create/update docs/README.md via GitHub API'].outputs.branch }}
          title: "docs: add OctoAcme project management README"
          body: |
            Adds docs/README.md as a central entrypoint for OctoAcme project management docs.

            This README includes a concise overview of roles, workflows, communication cadence,
            and quality assurance practices. See linked process documents for full details.

            Closes #2
          reviewers: marcinnowakiw
          labels: documentation